homework 6 (linear models)
================
Purnima Sharma
2020-12-08

## Problem 1

``` r
homicide_df = 
  read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1)
  ) %>% 
  filter(
    victim_race %in% c("White", "Black"),
    city_state != "Tulsa, AL") %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```

    ## Parsed with column specification:
    ## cols(
    ##   uid = col_character(),
    ##   reported_date = col_double(),
    ##   victim_last = col_character(),
    ##   victim_first = col_character(),
    ##   victim_race = col_character(),
    ##   victim_age = col_double(),
    ##   victim_sex = col_character(),
    ##   city = col_character(),
    ##   state = col_character(),
    ##   lat = col_double(),
    ##   lon = col_double(),
    ##   disposition = col_character()
    ## )

Start with one city.

``` r
baltimore_df =
  homicide_df %>% 
  filter(city_state == "Baltimore, MD")
glm(resolution ~ victim_age + victim_race + victim_sex, 
    data = baltimore_df,
    family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digits = 3)
```

| term              |    OR | CI\_lower | CI\_upper |
| :---------------- | ----: | --------: | --------: |
| (Intercept)       | 1.363 |     0.975 |     1.907 |
| victim\_age       | 0.993 |     0.987 |     1.000 |
| victim\_raceWhite | 2.320 |     1.648 |     3.268 |
| victim\_sexMale   | 0.426 |     0.325 |     0.558 |

Try this across cities.

``` r
models_results_df =
homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = 
      map(.x = data, ~glm(resolution ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
     results = map(models, broom::tidy)
  ) %>% 
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(city_state, term, OR, starts_with("CI"))
```

Make plots.

``` r
models_results_df %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() + 
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

<img src="p8105_hw6_ps3147_files/figure-gfm/unnamed-chunk-4-1.png" width="90%" />

## Problem 2

Effects of variables on child’s birthweight.

Load and clean data.

``` r
baby_df = 
  read_csv("./data/birthweight.csv") %>% 
  relocate(bwt) %>% 
  mutate(
    frace = as.factor(frace),
    babysex = as.factor(babysex),
    malform = as.factor(malform),
    mrace = as.factor(mrace)
  ) %>% 
  drop_na(bwt, blength, gaweeks, bhead, blength, babysex) 
```

    ## Parsed with column specification:
    ## cols(
    ##   .default = col_double()
    ## )

    ## See spec(...) for full column specifications.

Build regression model.

``` r
# scatterplot matrix and pairwise correlations
pairs(baby_df)
```

<img src="p8105_hw6_ps3147_files/figure-gfm/unnamed-chunk-6-1.png" width="90%" />

``` r
proposed_model = lm(bwt ~ gaweeks + wtgain + bhead * blength + ppbmi * ppwt, data = baby_df)

broom::tidy(proposed_model) 
```

    ## # A tibble: 9 x 5
    ##   term            estimate std.error statistic  p.value
    ##   <chr>              <dbl>     <dbl>     <dbl>    <dbl>
    ## 1 (Intercept)   -3493.      807.        -4.33  1.53e- 5
    ## 2 gaweeks          14.5       1.50       9.68  5.99e-22
    ## 3 wtgain            3.59      0.403      8.92  6.70e-19
    ## 4 bhead            48.6      24.6        1.98  4.81e- 2
    ## 5 blength          18.3      16.8        1.09  2.78e- 1
    ## 6 ppbmi            -1.55      5.16      -0.300 7.64e- 1
    ## 7 ppwt              5.23      0.875      5.98  2.39e- 9
    ## 8 bhead:blength     1.80      0.505      3.56  3.69e- 4
    ## 9 ppbmi:ppwt       -0.0806    0.0321    -2.51  1.21e- 2

``` r
proposed_model = lm(bwt ~ gaweeks + wtgain + ppwt + bhead * blength, data = baby_df) 

broom::tidy(proposed_model)
```

    ## # A tibble: 7 x 5
    ##   term          estimate std.error statistic  p.value
    ##   <chr>            <dbl>     <dbl>     <dbl>    <dbl>
    ## 1 (Intercept)   -3208.     803.       -3.99  6.60e- 5
    ## 2 gaweeks          14.5      1.50      9.63  9.79e-22
    ## 3 wtgain            3.76     0.403     9.34  1.44e-20
    ## 4 ppwt              1.57     0.216     7.25  4.93e-13
    ## 5 bhead            44.6     24.6       1.81  7.05e- 2
    ## 6 blength          16.4     16.9       0.973 3.30e- 1
    ## 7 bhead:blength     1.88     0.507     3.72  2.03e- 4

The proposed model is built based on the outcome of scatterplot matrix
and pairwise correlations to check for significant covariates and any
interaction terms. Due to insignificant p-value at 5% significance level
of ppbmi, it is removed from the model. Gestational age in weeks,
mother’s weight gain during pregnancy (lbs), mother’s pre-pregnancy
weight (lbs), interaction between baby’s head circumference (cm) and
length (cm) at birth are retained as significant factors underlying
baby’s birthweight.

Plot of residuals against fitted values.

``` r
modelr::add_residuals(baby_df, proposed_model) %>%
add_predictions(proposed_model) %>%
ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  geom_line(aes(y = 0), color = "red")
```

<img src="p8105_hw6_ps3147_files/figure-gfm/unnamed-chunk-7-1.png" width="90%" />

The residuals seem to be evenly distributed around zero for the
predicted birthweights (gm), except for some low-end outliers with
over-estimated residuals. For the most part, the cluster is around
2,000gm to 4,000gm of birthweight.

Compare models

``` r
model_one = lm(bwt ~ blength + gaweeks, data = baby_df)
broom::tidy(model_one) 
```

    ## # A tibble: 3 x 5
    ##   term        estimate std.error statistic  p.value
    ##   <chr>          <dbl>     <dbl>     <dbl>    <dbl>
    ## 1 (Intercept)  -4348.      98.0      -44.4 0.      
    ## 2 blength        129.       1.99      64.6 0.      
    ## 3 gaweeks         27.0      1.72      15.7 2.36e-54

``` r
model_two = lm(bwt ~ bhead * blength * babysex, data = baby_df)
broom::tidy(model_two) 
```

    ## # A tibble: 8 x 5
    ##   term                    estimate std.error statistic      p.value
    ##   <chr>                      <dbl>     <dbl>     <dbl>        <dbl>
    ## 1 (Intercept)            -7177.     1265.       -5.67  0.0000000149
    ## 2 bhead                    182.       38.1       4.78  0.00000184  
    ## 3 blength                  102.       26.2       3.90  0.0000992   
    ## 4 babysex2                6375.     1678.        3.80  0.000147    
    ## 5 bhead:blength             -0.554     0.780    -0.710 0.478       
    ## 6 bhead:babysex2          -198.       51.1      -3.88  0.000105    
    ## 7 blength:babysex2        -124.       35.1      -3.52  0.000429    
    ## 8 bhead:blength:babysex2     3.88      1.06      3.67  0.000245

``` r
proposed_model = lm(bwt ~ gaweeks + wtgain + ppwt + bhead * blength, data = baby_df)

# Cross-validation, 100 repetitions 
cv_df =
  crossv_mc(baby_df, 100) %>%   
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

#fit models and get prediction errors 
cv_df = 
cv_df %>%    
  mutate(
    model_one = map(.x = train, ~lm(bwt ~ blength + gaweeks, data = .x)), 
    model_two = map(.x = train, ~lm(bwt ~ bhead * blength * babysex, data = .x)),
    proposed_model = map(.x = train, ~lm(bwt ~ gaweeks + wtgain + ppwt + bhead * blength, data = .x))
  ) %>% 
  mutate(           
    rmse_model_one = map2_dbl(.x = model_one, .y = test, ~rmse(model = .x, data = .y)),
    rmse_model_two = map2_dbl(.x = model_two, .y = test, ~rmse(model = .x, data = .y)),
    rmse_proposed = map2_dbl(.x = proposed_model, .y = test, ~rmse(model = .x, data = .y))
  )
```

Plot to compare prediction errors.

``` r
cv_df %>% 
  select(starts_with("rmse")) %>%    
  pivot_longer(
    everything(),   
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"   
  ) %>%         
  ggplot(aes(x = model, y = rmse)) +
  geom_violin() 
```

<img src="p8105_hw6_ps3147_files/figure-gfm/unnamed-chunk-9-1.png" width="90%" />

The results show that the standard deviation of the residuals, given by
Root Mean Square Error (rmse) was the lowest in the proposed model, even
if just slightly lower than the given model 2. Clearly, there was a
great improvement in model-building from model 1 to model 2 and proposed
model.

## Problem 3
